--- pg_store_plans.c.old	2025-01-17 12:49:32.201367101 -0600
+++ pg_store_plans.c	2025-01-17 13:12:47.396259639 -0600
@@ -142,8 +142,13 @@
 	int64		local_blks_written;	/* # of local disk blocks written */
 	int64		temp_blks_read; 	/* # of temp blocks read */
 	int64		temp_blks_written;	/* # of temp blocks written */
+	#if (PG_VERSION_NUM < 170000)
 	double		blk_read_time;		/* time spent reading, in msec */
 	double		blk_write_time; 	/* time spent writing, in msec */
+	#else
+	double		shared_blk_read_time;		/* time spent reading, in msec */
+	double		shared_blk_write_time; 	/* time spent writing, in msec */
+	#endif
 	double		temp_blk_read_time;	/* time spent reading temp blocks,
 									   in msec */
 	double		temp_blk_write_time;/* time spent writing temp blocks,
@@ -1356,9 +1361,13 @@
 	e->counters.temp_blks_read += bufusage->temp_blks_read;
 	e->counters.temp_blks_written += bufusage->temp_blks_written;
 
+#if PG_VERSION_NUM < 170000
 	e->counters.blk_read_time += INSTR_TIME_GET_MILLISEC(bufusage->blk_read_time);
 	e->counters.blk_write_time += INSTR_TIME_GET_MILLISEC(bufusage->blk_write_time);
-
+#else
+	e->counters.shared_blk_read_time += INSTR_TIME_GET_MILLISEC(bufusage->shared_blk_read_time);
+	e->counters.shared_blk_write_time += INSTR_TIME_GET_MILLISEC(bufusage->shared_blk_write_time);
+#endif
 #if PG_VERSION_NUM >= 150000
 	e->counters.temp_blk_read_time += INSTR_TIME_GET_MILLISEC(bufusage->temp_blk_read_time);
 	e->counters.temp_blk_write_time += INSTR_TIME_GET_MILLISEC(bufusage->temp_blk_write_time);
@@ -1656,10 +1665,13 @@
 		values[i++] = Int64GetDatumFast(tmp.local_blks_read);
 		values[i++] = Int64GetDatumFast(tmp.local_blks_dirtied);
 		values[i++] = Int64GetDatumFast(tmp.local_blks_written);
-		values[i++] = Int64GetDatumFast(tmp.temp_blks_read);
-		values[i++] = Int64GetDatumFast(tmp.temp_blks_written);
+#if (PG_VERSION_NUM < 170000)
 		values[i++] = Float8GetDatumFast(tmp.blk_read_time);
 		values[i++] = Float8GetDatumFast(tmp.blk_write_time);
+#else
+		values[i++] = Float8GetDatumFast(tmp.shared_blk_read_time);
+		values[i++] = Float8GetDatumFast(tmp.shared_blk_write_time);
+#endif
 
 		if (api_version >= PGSP_V1_7)
 		{
@@ -1680,8 +1692,6 @@
 
 	LWLockRelease(shared_state->lock);
 
-	/* clean up and return the tuplestore */
-	tuplestore_donestoring(tupstore);
 }
 
 /* Number of output arguments (columns) for pg_stat_statements_info */
